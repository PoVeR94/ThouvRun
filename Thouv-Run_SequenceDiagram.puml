@startuml Thouv-Run Sequence Diagram - Score Sync
!theme vibrant

participant "Joueur (GUI)" as Player
participant "Moteur Jeu" as Engine
participant "Gestion Scores" as Scores
participant "API Serveur" as API
participant "Backup JSON" as Backup
participant "Leaderboard Web" as Web

== Partie 1 : Fin de Partie & Sauvegarde ==

Player -> Engine: [R] RedÃ©marrer / Fin
Engine -> Engine: fin_partie(cause)
Engine -> Scores: sauvegarder_nouveau_score(...)

== Ã‰tape 1 : Sauvegarde Locale ==

Scores -> Backup: Charger thouv_scores.json
Backup --> Scores: [score1, score2, ...]
Scores -> Scores: Ajouter nouveau score
Scores -> Backup: Ã‰crire thouv_scores.json
Backup --> Scores: âœ“ SauvegardÃ©

== Ã‰tape 2 : Envoi Asynchrone Ã  l'API ==

Scores -> Scores: Thread: _envoyer_score_api()
Scores ->> API: POST /api/scores [ASYNC]
API -> API: Valider & stocker en SQLite
API ->> Scores: âœ“ 200 OK [ASYNC]

== Ã‰tape 3 : Synchronisation du Backup ==

Scores -> Scores: Thread: _synchroniser_backup()
Scores ->> API: GET /api/scores?limit=500 [ASYNC]
API -> API: RÃ©cupÃ©rer tous les scores
API ->> Scores: [score1, ..., score191]

Scores -> Scores: Fusionner (local + serveur)
Scores -> Scores: DÃ©duplicater par (nom, date, score)
Scores -> Backup: Mettre Ã  jour thouv_scores.json
Backup --> Scores: âœ“ Backup synchronisÃ©

== Partie 2 : Leaderboard Web (Utilisateur diffÃ©rent) ==

Web -> Web: setInterval(10s)
Web ->> API: GET /api/scores?limit=500
API -> API: RÃ©cupÃ©rer depuis SQLite
API ->> Web: [191 scores JSON]

Web -> Web: Parser & afficher tableau
Web -> Web: Calculer stats (total, meilleur, joueurs)
Web --> Web: âœ“ Tableau mis Ã  jour

note right of Scores
  âš¡ Toutes les opÃ©rations
  aprÃ¨s sauvegarder_nouveau_score()
  s'exÃ©cutent en threads.
  Le jeu n'est jamais bloquÃ©!
end note

note bottom of Backup
  ğŸ’¾ Backup local = source de vÃ©ritÃ©
  En cas de perte serveur,
  les scores persistent dans Git!
end note

note bottom of API
  ğŸ”„ L'API est le point de sync
  RedÃ©marrage !== perte donnÃ©es
  (backup remonte Ã  chaque dÃ©marrage)
end note

@enduml
